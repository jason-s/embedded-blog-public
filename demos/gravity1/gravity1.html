<html>
<head>
<style type="text/css">
    div#statistics p {
        font-family: sans-serif;
        padding: 0;
        margin: 0;
    }
</style>
<script type="text/javascript" src="gravity1.js" ></script>
<script type="text/javascript">
window.onload = function() {
    var canvas = document.getElementById('gravity1-canvas');
    var gravity1 = new Gravity1Simulation();
    window.gravity1 = gravity1;
    var fps = 20;
    var tick = 0;
    var k = 16;
    var dtsim = 1.0/k/fps;
    var keymap = {37: 'left', 38: 'up', 39: 'right', 40: 'down', 73: 'e+', 74:'E-', 75:'e-', 76:'E+', 107:'+', 109:'-'};
    var keystate = {'up':false, 'down':false, 'left':false, 'right':false, 'e+':false, 'e-': false, 'E+':false, 'E-':false, 'shift':false, 'alt':false, 'ctrl':false, '+':false, '-':false};
    var keypress = {};
    function modkey(event,isdown)
    {
        var keycode = event.keyCode;
        keystate['shift'] = event.shiftKey;
        keystate['ctrl'] = event.ctrlKey;
        keystate['alt'] = event.altKey;
        if (keycode in keymap)
        {
            var m = keymap[keycode];
            var prevstate = keystate[m];
            keystate[m] = isdown;
            if (isdown && !prevstate)
                keypress[m] = true; 
            //console.log(keystate,keypress);
            return true;
        }
        else
        {
            //console.log(keycode, isdown);
            return false;
        }
    }    
    document.addEventListener('keydown',function(event) { 
        if (modkey(event, true)) { event.preventDefault(true); return false;} });
    document.addEventListener('keyup',function(event) { 
        if (modkey(event, false)) {  event.preventDefault(true); return false;} });
    function settextvalue(id,value)
    {
        var s = isNaN(value) ? '---' : (''+value.toFixed(7)); 
        document.getElementById(id).textContent = s;
    }
    function showStatistics(sim)
    {
        var stats = sim.getStatistics();
        settextvalue('speed',stats.speed);
        settextvalue('radius',stats.radius);
        settextvalue('minradius',stats.minRadius);
        settextvalue('maxradius',stats.maxRadius);
        settextvalue('angmomentum',stats.angularMomentum);
        settextvalue('eccentricity',stats.eccentricity);
        var ke = stats.kineticEnergy;
        var pe = stats.potentialEnergy;
        settextvalue('total energy',ke+pe);
        settextvalue('period',stats.period);
    }
    setInterval(function() {
        ++tick;
        gravity1.updateControls(keystate,keypress);
        keypress = {};
        
        for (var i = 0; i < k; ++i)
            gravity1.update(dtsim);
        var blink = (tick & 7) > 1;
        gravity1.draw(canvas, blink);
        var ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#ff0000';
        gravity1.drawOrbitPath(canvas);
        ctx.stroke();
        showStatistics(gravity1);
    }, 1000/fps)
    var form = document.forms['options'];
    var solverChange = function(event) {
            gravity1.solver = event.target.value;
    };
    var solverDiv = document.getElementById('solvers');
    for (var i = 0; i < gravity1.solverNames.length; ++i)
    {
        var name = gravity1.solverNames[i];
        var rbtn = document.createElement('input');
        rbtn.setAttribute('type','radio');
        rbtn.setAttribute('name','solver');
        rbtn.setAttribute('value',name);
        rbtn.addEventListener('change',solverChange);
        solverDiv.appendChild(rbtn);
        solverDiv.appendChild(document.createTextNode(name));
        solverDiv.appendChild(document.createElement('br'));
    }
}
</script>
</head>
<body>
    <div>
    <canvas id="gravity1-canvas" height="480" width="640" />
    </div>
    <div id='statistics'>
        <p>Speed = <span id='speed'></span></p>
        <p>Radius = <span id='radius'></span></p>
        <p>Min radius = <span id='minradius'></span></p>
        <p>Max radius = <span id='maxradius'></span></p>
        <p>Period = <span id='period'></span></p>
        <p>Angular momentum = <span id='angmomentum'></span></p>
        <p>Eccentricity = <span id='eccentricity'></span></p>
        <p>Total energy = <span id='total energy'></span></p>
    </div>
    <div id='optionsForm'>
        <form name='options'>
            <div id='solvers' />
        </form>
    </div>
</body>
</html>